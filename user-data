#cloud-config
autoinstall:
  version: 1

  refresh-installer:
    update: no

  apt:
    geoip: true
    preserve_sources_list: false
    primary:
     - arches: [amd64, i386]
       uri: http://archive.ubuntu.com/ubuntu
     - arches: [default]
       uri: http://ports.ubuntu.com/ubuntu-ports
    # Repos for extra packages must go into sources. 
    #sources: 
  ssh:
    install-server: true
    allow-pw: false
  keyboard: 
    layout: us
    toggle: null
    variant: ''
  locale: C
  network:
    version: 2
    ethernets:
      maineth:
        match:
          name: "en*"
        dhcp4: true
  storage:
    config:
      # drive Hardware
      - ptable: gpt
        path: /dev/sda
        wipe: superblock
        preserve: false
        name: ''
        grub_device: false
        type: disk
        id: disk-sda
        match:
          # ssd: yes
          size: largest
      # efi (bios partition) ~512MB
      - device: disk-sda
        size: 536870912
        wipe: superblock
        flag: boot
        number: 1
        preserve: false
        grub_device: true
        type: partition
        id: partition-0
      - fstype: fat32
        volume: partition-0
        preserve: false
        type: format
        id: format-0
      - device: format-0
        path: /boot/efi
        type: mount
        id: mount-0
      # 1GB Boot Partition
      - device: disk-sda
        size: 1073741824
        wipe: superblock
        flag: ''
        number: 2
        preserve: false
        grub_device: false
        type: partition
        id: partition-1
      - fstype: btrfs
        volume: partition-1
        preserve: false
        type: format
        id: format-1
      - device: format-1
        path: /boot
        type: mount
        id: mount-1
      # ~ 1.8TB System Data
      - device: disk-sda
        # use all the remaining space (in case we have different drive sizes)
        size: -1
        wipe: superblock
        flag: ''
        number: 3
        preserve: false
        grub_device: false
        type: partition
        id: partition-2
      - fstype: btrfs
        volume: partition-2
        preserve: false
        type: format
        id: format-2
      - device: format-2
        path: /
        type: mount
        id: mount-2
  
  user-data:
    timezone: Europe/Zurich
    hostname: multimico
    users: 
      - name: multimico
        passwd: "$6$GZ2QZKpiMQIhRI/O$E2QgSCFz9MsWhOgV9zdFUEGbpLrExXEZ5XZrpjZbjMZcUg5sq8ozJU074qBEWfvs8c9zrQdbzsNr9w7J7PAuH."
        shell: /bin/bash
        # the multimico team is granted access to the host
        ssh_import_id: 
          - gh:phish108
          - gh:bajkad
        groups:
          - sudo
          - lxd
          - adm
          - plugdev
          - cdrom
        lock_passwd: false

    # package update is needed for extra installs
    package_update: true

    # package upgrade and reboot should run via ansible
    package_upgrade: false
    package_reboot_if_required: true

    # Not sure whether this should go also into bootstrapping
    packages:
      - petname
      - openvswitch-switch-dpdk
      - libosinfo-bin
      
    # Once the machine is up, no cloud-init should run
    write_files: 
      - path: /etc/cloud/cloud-init.disabled
        content: " "

    # The following commands run after all package updates and installs
    # This runs after first reboot
    runcmd:
      # bootstrap the machine specific installation
      - mkdir -p /run/multimico/init
      - git clone https://github.com/multimico/init.git /run/multimico/init && bash /run/multimico/init/bin/init.sh
      - "echo '%admin ALL= NOPASSWD:/usr/bin/apt' > /etc/sudoers.d/01_apt_admins" 
